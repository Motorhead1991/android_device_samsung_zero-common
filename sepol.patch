From 9efe7565fcf1579824049289abc3d73942a437fa Mon Sep 17 00:00:00 2001
From: Usaamah Patel <ussyp2015@gmail.com>
Date: Sun, 21 May 2017 19:23:16 +0100
Subject: [PATCH] Import/Update sepolicy from Team Nexus

Signed-off-by: Usaamah Patel <ussyp2015@gmail.com>
---
 sepolicy/audioserver.te   |   7 ++++
 sepolicy/bluetooth.te     |   4 ++
 sepolicy/cameraserver.te  |   8 ++++
 sepolicy/cpboot-daemon.te |  12 ++----
 sepolicy/device.te        |  16 ++++++--
 sepolicy/dex2oat.te       |   2 +
 sepolicy/file.te          |  22 ++++++----
 sepolicy/file_contexts    | 102 +++++++++++++++++++++++++++-------------------
 sepolicy/fingerprintd.te  |   5 ++-
 sepolicy/hostapd.te       |   2 +
 sepolicy/init.te          |   6 +++
 sepolicy/kernel.te        |  20 ++++++++-
 sepolicy/lhd.te           |  45 +++++++-------------
 sepolicy/logd.te          |   1 +
 sepolicy/mediacodec.te    |   3 ++
 sepolicy/mediaserver.te   |   3 ++
 sepolicy/netd.te          |   2 +
 sepolicy/nfc.te           |   3 +-
 sepolicy/priv_app.te      |   6 +++
 sepolicy/rild.te          |  22 +++++++++-
 sepolicy/system_server.te |  20 ++++++++-
 sepolicy/tee.te           |  11 +++++
 sepolicy/ueventd.te       |   2 +-
 sepolicy/untrusted_app.te |   8 ++++
 sepolicy/zygote.te        |   4 ++
 25 files changed, 237 insertions(+), 99 deletions(-)
 create mode 100644 sepolicy/audioserver.te
 create mode 100644 sepolicy/cameraserver.te
 create mode 100644 sepolicy/dex2oat.te
 create mode 100644 sepolicy/hostapd.te
 create mode 100644 sepolicy/logd.te
 create mode 100644 sepolicy/mediacodec.te
 create mode 100644 sepolicy/priv_app.te
 create mode 100644 sepolicy/zygote.te

diff --git a/sepolicy/audioserver.te b/sepolicy/audioserver.te
new file mode 100644
index 0000000..3e74efa
--- /dev/null
+++ b/sepolicy/audioserver.te
@@ -0,0 +1,7 @@
+allow audioserver rild:unix_stream_socket connectto;
+allow audioserver sec_efs_file:dir search;
+allow audioserver sec_efs_file:file { read open };
+allow audioserver sysfs_audience_control:file rw_file_perms;
+
+# Allow rild to connect to gpsd
+unix_socket_connect(audioserver, property, rild)
diff --git a/sepolicy/bluetooth.te b/sepolicy/bluetooth.te
index 6a951c4..226151a 100644
--- a/sepolicy/bluetooth.te
+++ b/sepolicy/bluetooth.te
@@ -3,3 +3,7 @@ allow bluetooth bluetooth_device:chr_file { rw_file_perms ioctl };
 
 # /data/.cid.info
 allow bluetooth wifi_data_file:file r_file_perms;
+
+allow bluetooth sysfs:file write;
+
+allow bluetooth gps_device:chr_file { open ioctl };
diff --git a/sepolicy/cameraserver.te b/sepolicy/cameraserver.te
new file mode 100644
index 0000000..bdc89e3
--- /dev/null
+++ b/sepolicy/cameraserver.te
@@ -0,0 +1,8 @@
+# /sys/devices/virtual/camera/*/*_camfw
+# /dev/m2m1shot_jpeg
+allow cameraserver camera_device:dir { search };
+allow cameraserver camera_device:file { read write open getattr };
+allow cameraserver camera_device:chr_file { read write open getattr ioctl };
+allow camera_device sysfs:filesystem associate;
+allow cameraserver camera_data_file:file { read open };
+allow cameraserver media_rw_data_file:dir search;
diff --git a/sepolicy/cpboot-daemon.te b/sepolicy/cpboot-daemon.te
index 3987233..7106ad5 100644
--- a/sepolicy/cpboot-daemon.te
+++ b/sepolicy/cpboot-daemon.te
@@ -7,6 +7,7 @@ init_daemon_domain(cpboot-daemon)
 wakelock_use(cpboot-daemon)
 
 allow cpboot-daemon self:capability { dac_override setuid setgid };
+allow cpboot-daemon cpboot-daemon_exec:file { entrypoint };
 
 # FIXME neverallow rule
 # allow cpboot-daemon self:capability mknod;
@@ -23,11 +24,12 @@ allow cpboot-daemon kmsg_device:chr_file rw_file_perms;
 allow cpboot-daemon mif_device:chr_file rw_file_perms;
 # /dev/mbin0
 allow cpboot-daemon emmcblk_device:blk_file r_file_perms;
-# /dev/spi_boot_link
-allow cpboot-daemon radio_device:chr_file rw_file_perms;
 # /dev/block/mmcblk0p13
 allow cpboot-daemon block_device:dir r_dir_perms;
 
+# /dev/block/sda8 || /dev/block/platform/15570000.ufs/by-name/RADIO
+allow cpboot-daemon radio_block_device:blk_file r_file_perms;
+
 # /dev/mipi-lli/lli_control
 allow cpboot-daemon sysfs_mipi_writable:file rw_file_perms;
 
@@ -37,12 +39,6 @@ allow cpboot-daemon efs_file:dir r_dir_perms;
 # /efs/nv_data.bin
 allow cpboot-daemon bin_nv_data_efs_file:file rw_file_perms;
 
-# /sys/bus/usb/devices/1-2/idVendor
-allow cpboot-daemon sysfs:file r_file_perms;
-
-# /proc/cmdline
-allow cpboot-daemon proc:file r_file_perms;
-
 # set properties on boot
 set_prop(cpboot-daemon, cpboot-daemon_prop)
 set_prop(cpboot-daemon, radio_prop)
diff --git a/sepolicy/device.te b/sepolicy/device.te
index 8e73f63..22eb6d2 100644
--- a/sepolicy/device.te
+++ b/sepolicy/device.te
@@ -1,6 +1,8 @@
 # /dev/ttySAC3
 type bluetooth_device, dev_type;
 
+type bbd_device, dev_type;
+
 # /dev/block/mmcblk0p[0-9] (/dev/mbin0)
 type emmcblk_device, file_type;
 
@@ -10,14 +12,22 @@ type mif_device, dev_type;
 # /dev/rfkill
 type rfkill_device, dev_type;
 
+# /dev/knox_kap
+type knox_kap_device, dev_type;
+
 # /dev/seiren
 type seiren_device, dev_type;
 
 # /dev/s5p-smem
 type secmem_device, dev_type;
 
-# /dev/bbd*, /dev/ttyBCM[0-9]*
-type bbd_device, dev_type;
-
 # efs
 type efs_block_device, dev_type;
+
+type radio_block_device, dev_type;
+
+type uart_device, dev_type;
+
+type vfs_device, dev_type;
+
+type batch_io_device, dev_type;
diff --git a/sepolicy/dex2oat.te b/sepolicy/dex2oat.te
new file mode 100644
index 0000000..23ac357
--- /dev/null
+++ b/sepolicy/dex2oat.te
@@ -0,0 +1,2 @@
+allow zygote debugfs_trace_marker:file r_file_perms;
+allow dex2oat sysfs_debug:file r_file_perms;
diff --git a/sepolicy/file.te b/sepolicy/file.te
index 546ed11..682fe97 100644
--- a/sepolicy/file.te
+++ b/sepolicy/file.te
@@ -1,28 +1,36 @@
 ### efs types
 type app_efs_file, file_type;
-type baro_delta_factoryapp_efs_file, file_type;
+type battery_efs_file, file_type;
 type bin_nv_data_efs_file, file_type;
 type nv_log_efs_file, file_type;
 # widewine, drm
 type cpk_efs_file, file_type;
 type drm_efs_file, file_type;
-type factorymode_factoryapp_efs_file, file_type;
 type imei_efs_file, file_type;
 type prov_efs_file, file_type;
-type radio_factoryapp_efs_file, file_type;
 type sensor_efs_file, file_type;
+type sec_efs_file, file_type;
 type wifi_efs_file, file_type;
 
 ### sysfs types
 type sysfs_mdnie_writable, fs_type, sysfs_type, mlstrustedobject;
 type sysfs_mipi_writable, fs_type, sysfs_type, mlstrustedobject;
 type sysfs_multipdp_writable, fs_type, sysfs_type, mlstrustedobject;
-type sysfs_sec, fs_type, fs_type, fs_type, mlstrustedobject;
+type sysfs_audience_control, fs_type, sysfs_type, mlstrustedobject;
 
 allow sysfs_type tmpfs:filesystem associate;
 
-type vfs_device, dev_type;
+type biometrics_data_file, file_type;
 
-type batch_io_device, dev_type;
+type mobicore_data_file, file_type;
 
-type fingerprint_data_file, file_type;
+### debugging
+type sysfs_debug, fs_type, sysfs_type, mlstrustedobject;
+type sysfs_debug_untrusted, fs_type, sysfs_type, mlstrustedobject;
+
+####################################
+# Nexus7420 Power HAL
+#
+type power_hal_devfs, dev_type;
+type power_hal_sysfs, fs_type, sysfs_type, mlstrustedobject;
+type power_hal_data_files, file_type;
diff --git a/sepolicy/file_contexts b/sepolicy/file_contexts
index 57aae75..a568da6 100644
--- a/sepolicy/file_contexts
+++ b/sepolicy/file_contexts
@@ -12,6 +12,12 @@
 
 /dev/batch_io                u:object_r:batch_io_device:s0
 
+/dev/bbd_control             u:object_r:bbd_device:s0
+/dev/bbd_patch               u:object_r:bbd_device:s0
+/dev/bbd_sensor              u:object_r:bbd_device:s0
+/dev/bbd_packet              u:object_r:bbd_device:s0
+/dev/bbd_reliable            u:object_r:bbd_device:s0
+
 /dev/s5p-smem                u:object_r:secmem_device:s0
 /dev/mobicore                u:object_r:tee_device:s0
 /dev/mobicore-user           u:object_r:tee_device:s0
@@ -20,6 +26,8 @@
 /dev/v4l-subdev[0-9]*        u:object_r:video_device:s0
 /dev/media[0-3]*             u:object_r:camera_device:s0
 /dev/m2m1shot_jpeg           u:object_r:camera_device:s0
+/dev/m2m1shot_scaler0        u:object_r:video_device:s0
+/dev/m2m1shot_scaler1        u:object_r:video_device:s0
 
 /dev/mtp_usb*                u:object_r:mtp_device:s0
 
@@ -28,35 +36,26 @@
 /dev/ehci_power              u:object_r:mif_device:s0
 /dev/mipi-lli/lli_control    u:object_r:mif_device:s0
 
-/dev/ttySAC[0-9]*            u:object_r:gps_device:s0
+/dev/ttyBCM[0-9]*            u:object_r:bbd_device:s0
+/dev/ttySAC[0-9]*            u:object_r:uart_device:s0
 
 /dev/block/mmcblk0p[0-9]*    u:object_r:emmcblk_device:s0
 
 /dev/block/platform/15570000.ufs/by-name/EFS  u:object_r:efs_block_device:s0
 /dev/block/platform/15570000.ufs/by-name/CACHE    u:object_r:cache_block_device:s0
 /dev/block/platform/15570000.ufs/by-name/USERDATA    u:object_r:userdata_block_device:s0
+/dev/block/platform/15570000.ufs/by-name/RADIO   u:object_r:radio_block_device:s0
+/dev/block/sda8   u:object_r:radio_block_device:s0
 
 /dev/rfkill                  u:object_r:rfkill_device:s0
-
-/dev/bbd_control             u:object_r:bbd_device:s0
-/dev/bbd_packet              u:object_r:bbd_device:s0
-/dev/bbd_patch               u:object_r:bbd_device:s0
-/dev/bbd_reliable            u:object_r:bbd_device:s0
-/dev/bbd_sensor              u:object_r:bbd_device:s0
-/dev/bbd_sio                 u:object_r:bbd_device:s0
-/dev/ttyBCM[0-9]*            u:object_r:bbd_device:s0
+/dev/knox_kap                u:object_r:knox_kap_device:s0
 
 ####################################
 # efs files
-/efs/FactoryApp(/.*)?        u:object_r:app_efs_file:s0
-/efs/FactoryApp/baro_delta   u:object_r:baro_delta_factoryapp_efs_file:s0
-/efs/FactoryApp/factorymode  u:object_r:factorymode_factoryapp_efs_file:s0
-/efs/FactoryApp/fdata        u:object_r:radio_factoryapp_efs_file:s0
-/efs/FactoryApp/hist_nv      u:object_r:radio_factoryapp_efs_file:s0
-/efs/FactoryApp/test_nv      u:object_r:radio_factoryapp_efs_file:s0
-
 /efs/bluetooth(/.*)?         u:object_r:bluetooth_efs_file:s0
+/efs/Battery(/.*)?           u:object_r:battery_efs_file:s0
 /efs/drm(/.*)?               u:object_r:drm_efs_file:s0
+/efs/FactoryApp(/.*)?        u:object_r:app_efs_file:s0
 /efs/gyro_cal_data           u:object_r:sensor_efs_file:s0
 /efs/h2k.dat                 u:object_r:cpk_efs_file:s0
 /efs/imei(/.*)?              u:object_r:imei_efs_file:s0
@@ -64,69 +63,86 @@
 /efs/nv.log                  u:object_r:nv_log_efs_file:s0
 /efs/prov(/.*)?              u:object_r:prov_efs_file:s0
 /efs/prov_data(/.*)?         u:object_r:prov_efs_file:s0
+/efs/sec_efs(/.*)?           u:object_r:sec_efs_file:s0
 /efs/wifi(/.*)?              u:object_r:wifi_efs_file:s0
 /efs/wv.keys                 u:object_r:cpk_efs_file:s0
 
 ####################################
 # data files
+/data/camera(/.*)?           u:object_r:camera_data_file:s0
 /data/nfc(/.*)?              u:object_r:nfc_data_file:s0
 /data/.cid.info              u:object_r:wifi_data_file:s0
 /data/.wifiver.info          u:object_r:wifi_data_file:s0
-
 /data/misc/radio(/.*)?       u:object_r:radio_data_file:s0
 
-# fingerprint
-/data/biometrics(/.*)?       u:object_r:fingerprint_data_file:s0
+# biometrics
+/data/biometrics(/.*)?	     u:object_r:biometrics_data_file:s0
 
+####################################
 # gps
-/data/system/gps/\.flp\.interface\.pipe\.to_gpsd     u:object_r:gps_data_file:s0
-/data/system/gps/\.gps\.interface\.pipe\.to_gpsd     u:object_r:gps_data_file:s0
-/data/system/gps/\.gps\.interface\.pipe\.to_jni      u:object_r:gps_data_file:s0
-/data/system/gps/\.pipe\.gpsd_to_lhd\.to_server      u:object_r:gps_data_file:s0
-/data/system/gps/\.gpsd\.lock                        u:object_r:gps_data_file:s0
-/data/system/gps/gldata\.sto                         u:object_r:gps_data_file:s0
-/data/system/gps/alt\.dat                            u:object_r:gps_data_file:s0
-/data/system/gps/lto2\.dat                           u:object_r:gps_data_file:s0
-/data/system/gps/ltoStatus\.txt                      u:object_r:gps_data_file:s0
-
-/data/gps/ctrlpipe                                   u:object_r:gps_data_file:s0
-/data/gps/.gpslogd.pipe                              u:object_r:gps_data_file:s0
-/data/gps/nmeapipe                                   u:object_r:gps_data_file:s0
+/data/system/gps(/.*)?       u:object_r:gps_data_file:s0
+
+# tee
+/data/misc/mcRegistry(/.*)?  u:object_r:mobicore_data_file:s0
 
 ####################################
 # sysfs files
-/sys/class/power_supply/battery/music -- u:object_r:sysfs_writable:s0
-/sys/class/devfreq/exynos5-busfreq-mif(/.*)? -- u:object_r:sysfs_writable:s0
-/sys/class/lcd(/.*)?         -- u:object_r:sysfs_writable:s0
-/sys/class/sec(/.*)?         -- u:object_r:sysfs_sec:s0
+/sys/class/power_supply/battery/music			-- u:object_r:sysfs_writable:s0
+/sys/class/devfreq/exynos5-busfreq-mif(/.*)?	-- u:object_r:sysfs_writable:s0
+/sys/class/lcd(/.*)?							-- u:object_r:sysfs_writable:s0
+/sys/devices/virtual/earsmart/control(/.*)?    	-- u:object_r:sysfs_audience_control:s0   
 
+####################################
 # bluetooth
 /sys/devices/bluetooth.[0-9]*/rfkill/rfkill0/state  u:object_r:sysfs_bluetooth_writable:s0
 /sys/devices/bluetooth.[0-9]*/rfkill/rfkill0/type   u:object_r:sysfs_bluetooth_writable:s0
 
-# CP device
-/dev/spi_boot_link              u:object_r:radio_device:s0
+####################################
+# camera
+/sys/devices/virtual/camera(/.*)?           u:object_r:camera_device:s0
 
+####################################
 # cbd
 /sys/devices/10f24000.mipi-lli/lli_control  u:object_r:sysfs_mipi_writable:s0
 
+####################################
 # rild
+/data/data/com.android.providers.telephony/databases(/.*)?     u:object_r:radio_data_file:s0
+/data/data/com.android.providers.telephony/shared_prefs(/.*)?  u:object_r:radio_data_file:s0
 /sys/devices/virtual/misc/multipdp(/.*)     u:object_r:sysfs_multipdp_writable:s0
+/dev/socket/rild2                           u:object_r:rild_socket:s0
+/dev/socket/rild-debug[0-9]*                u:object_r:rild_debug_socket:s0
 
+####################################
 # mDNIe
 /sys/devices/[0-9]*.decon_fb/lcd/panel/mdnie/mode       u:object_r:sysfs_mdnie_writable:s0
 /sys/devices/[0-9]*.decon_fb/lcd/panel/mdnie/scenario   u:object_r:sysfs_mdnie_writable:s0
 
 ####################################
 # deamons
-#
-
 /system/bin/mcDriverDaemon   u:object_r:tee_exec:s0
 /system/bin/macloader        u:object_r:macloader_exec:s0
 /system/bin/modemloader      -- u:object_r:modemloader_exec:s0
 /system/bin/sensorhubservice -- u:object_r:sensorhubservice_exec:s0
 /system/bin/wifiloader       -- u:object_r:wifiloader_exec:s0
-
-/sbin/cbd                    -- u:object_r:rootfs:s0
+/sbin/cbd                    -- u:object_r:cpboot-daemon_exec:s0
 /system/bin/gpsd             -- u:object_r:gpsd_exec:s0
-/system/bin/lhd               -- u:object_r:lhd_exec:s0
+/system/bin/lhd              -- u:object_r:lhd_exec:s0
+
+####################################
+# debugging
+/sys/kernel/debug/mali/mem                   -- u:object_r:sysfs_debug:s0
+/sys/kernel/debug/tracing/trace_(marker)     -- u:object_r:sysfs_debug_untrusted:s0
+/sys/kernel/debug/wakeup_sources             -- u:object_r:sysfs_debug_untrusted:s0
+
+####################################
+# Nexus7420 Power HAL
+#
+/sys/class/input/input[0-9]*/enabled                             u:object_r:power_hal_sysfs:s0
+/sys/class/misc/mali0/device/dvfs(.*)?                           u:object_r:power_hal_sysfs:s0
+/sys/devices/system/cpu/cpu[0-9]*/online                         u:object_r:power_hal_sysfs:s0
+/sys/devices/system/cpu/cpu[0-9]*/cpufreq/scaling_max_freq       u:object_r:power_hal_sysfs:s0
+/sys/devices/system/cpu/cpu[0-9]*/cpufreq/scaling_min_freq       u:object_r:power_hal_sysfs:s0
+/sys/devices/system/cpu/cpu[0-9]*/cpufreq/interactive(/.*)?      u:object_r:power_hal_sysfs:s0
+/sys/power/enable_dm_hotplug                                     u:object_r:power_hal_sysfs:s0
+/data/power(/.*)                                                 u:object_r:power_hal_data_files:s0
diff --git a/sepolicy/fingerprintd.te b/sepolicy/fingerprintd.te
index b42edca..a5fd69d 100644
--- a/sepolicy/fingerprintd.te
+++ b/sepolicy/fingerprintd.te
@@ -1,4 +1,7 @@
 allow fingerprintd tee_device:chr_file { open read write ioctl };
 allow fingerprintd secmem_device:chr_file { open read write ioctl };
 allow fingerprintd vfs_device:chr_file { open read write ioctl };
-allow fingerprintd fingerprint_data_file:file rw_file_perms;
+allow fingerprintd biometrics_data_file:dir { rmdir read write remove_name create open add_name search };
+allow fingerprintd biometrics_data_file:file { write create read rename open getattr unlink };
+allow fingerprintd tee:unix_stream_socket { connectto };
+allow fingerprintd power_hal_data_files:file rw_file_perms;
diff --git a/sepolicy/hostapd.te b/sepolicy/hostapd.te
new file mode 100644
index 0000000..adae69d
--- /dev/null
+++ b/sepolicy/hostapd.te
@@ -0,0 +1,2 @@
+allow hostapd wifi_efs_file:dir search;
+allow hostapd wifi_efs_file:file { read open };
diff --git a/sepolicy/init.te b/sepolicy/init.te
index 5d93a33..ef07bbc 100644
--- a/sepolicy/init.te
+++ b/sepolicy/init.te
@@ -26,3 +26,9 @@ allow init log_device:chr_file write;
 allow init property_socket:sock_file write;
 
 allow init system_data_file:fifo_file write;
+
+allow init camera_device:file { relabelto setattr };
+allow init camera_device:lnk_file { relabelto };
+allow init camera_device:dir { relabelto };
+allow init debugfs:file write;
+allow init efs_file:dir mounton;
diff --git a/sepolicy/kernel.te b/sepolicy/kernel.te
index 40176ed..6924350 100644
--- a/sepolicy/kernel.te
+++ b/sepolicy/kernel.te
@@ -7,9 +7,25 @@ allow kernel device:dir { create write remove_name rmdir add_name };
 allow kernel device:chr_file { create setattr getattr unlink };
 
 # /sys/devices/system/cpu/cpu[0-9]/cpufreq/*
-allow kernel kernel:capability { chown };
+allow kernel kernel:capability { chown dac_override };
 allow kernel sysfs_devices_system_cpu:file { setattr };
 allow kernel sysfs:file { setattr };
 
 allow kernel app_efs_file:dir search;
-allow kernel app_efs_file:file write;
+allow kernel app_efs_file:file { read write open };
+
+allow kernel efs_file:dir search;
+allow kernel battery_efs_file:dir { search open read };
+allow kernel battery_efs_file:file { read open };
+
+####################################
+# Nexus7420 Power HAL
+#
+# directory
+allow system_server power_hal_sysfs:dir       rw_dir_perms;
+allow system_server power_hal_sysfs:dir       rw_dir_perms;
+allow system_server power_hal_data_files:dir  rw_dir_perms;
+# files
+allow system_server power_hal_devfs:file      rw_file_perms;
+allow system_server power_hal_sysfs:file      rw_file_perms;
+allow system_server power_hal_data_files:file rw_file_perms;
diff --git a/sepolicy/lhd.te b/sepolicy/lhd.te
index 82fd377..436e422 100644
--- a/sepolicy/lhd.te
+++ b/sepolicy/lhd.te
@@ -1,37 +1,20 @@
-#### lhd (sensorhubs)
+#### lhd
 #
-
-type lhd, domain;
+type lhd, domain, domain_deprecated;
 type lhd_exec, exec_type, file_type;
 
-init_daemon_domain(lhd)
-
-net_domain(lhd)
-
-########## self and domain_type
-allow lhd self:capability2 block_suspend;
-
-########## fs_type
-allow lhd sysfs:file rw_file_perms;
-allow lhd sysfs_sec:dir rw_dir_perms;
-allow lhd sysfs_sec:{ file lnk_file } rw_file_perms;
-allow lhd sysfs_wake_lock:file rw_file_perms;
-
-########## dev_type
-allow lhd bbd_device:chr_file rw_file_perms;
+allow lhd bbd_device:chr_file { read write getattr open ioctl };
 
-########## file_type
-allow lhd efs_file:dir r_dir_perms;
-allow lhd efs_file:file r_file_perms;
-allow lhd system_data_file:dir create_dir_perms;
+allow lhd efs_file:dir search;
+allow lhd gps_data_file:dir { search write add_name };
 
-allow lhd system_data_file:file r_file_perms;
-allow lhd system_data_file:fifo_file create_file_perms;
-
-allow lhd gps_data_file:dir create_dir_perms;
-allow lhd gps_data_file:file create_file_perms;
-allow lhd gps_data_file:fifo_file create_file_perms;
-
-########## etc_type
-allow lhd port:tcp_socket name_bind;
+allow lhd fwmarkd_socket:sock_file write;
+allow lhd gps_data_file:fifo_file { read write open };
+allow lhd gps_data_file:file { write lock open create };
 allow lhd node:tcp_socket node_bind;
+allow lhd port:tcp_socket name_bind;
+allow lhd sec_efs_file:dir search;
+allow lhd self:tcp_socket { bind connect create };
+allow lhd sysfs:file { read write open };
+
+init_daemon_domain(lhd);
diff --git a/sepolicy/logd.te b/sepolicy/logd.te
new file mode 100644
index 0000000..50e687d
--- /dev/null
+++ b/sepolicy/logd.te
@@ -0,0 +1 @@
+allow logd self:capability { dac_read_search dac_override };
diff --git a/sepolicy/mediacodec.te b/sepolicy/mediacodec.te
new file mode 100644
index 0000000..c7601ec
--- /dev/null
+++ b/sepolicy/mediacodec.te
@@ -0,0 +1,3 @@
+allow mediacodec system_file:dir { read open };
+allow mediacodec sysfs:file { read open getattr };
+allow mediacodec seiren_device:chr_file { ioctl rw_file_perms };
diff --git a/sepolicy/mediaserver.te b/sepolicy/mediaserver.te
index 829a925..1ad3da6 100644
--- a/sepolicy/mediaserver.te
+++ b/sepolicy/mediaserver.te
@@ -9,6 +9,9 @@ allow mediaserver efs_file:dir r_dir_perms;
 # /efs/wv.keys
 allow mediaserver efs_file:file r_file_perms;
 
+# /dev/m2m1shot_jpeg
+allow mediaserver camera_device:chr_file { read write open getattr ioctl };
+
 # Snap permissions
 allow mediaserver sensorservice_service:service_manager { find };
 allow mediaserver system_server:unix_stream_socket { read write };
diff --git a/sepolicy/netd.te b/sepolicy/netd.te
index a586150..74a676c 100644
--- a/sepolicy/netd.te
+++ b/sepolicy/netd.te
@@ -1 +1,3 @@
 allow netd self:capability sys_module;
+allow netd dhcp_data_file:dir setattr;
+allow netd wifi_data_file:sock_file { create setattr unlink };
diff --git a/sepolicy/nfc.te b/sepolicy/nfc.te
index 727a835..b65fda1 100644
--- a/sepolicy/nfc.te
+++ b/sepolicy/nfc.te
@@ -1 +1,2 @@
-allow nfc unlabeled:dir search;
+allow nfc efs_file:dir search;
+allow nfc sec_efs_file:dir search;
diff --git a/sepolicy/priv_app.te b/sepolicy/priv_app.te
new file mode 100644
index 0000000..87411fc
--- /dev/null
+++ b/sepolicy/priv_app.te
@@ -0,0 +1,6 @@
+# power-HAL
+allow priv_app power_hal_data_files:file rw_file_perms;
+
+# su-daemon
+allow priv_app superuser_device:sock_file write;
+allow priv_app sudaemon:unix_stream_socket connectto;
diff --git a/sepolicy/rild.te b/sepolicy/rild.te
index 041b621..d847b96 100644
--- a/sepolicy/rild.te
+++ b/sepolicy/rild.te
@@ -6,6 +6,20 @@ allow rild imei_efs_file:file r_file_perms;
 allow rild app_efs_file:dir r_dir_perms;
 allow rild app_efs_file:file r_file_perms;
 
+allow cpboot-daemon self:capability { dac_read_search };
+
+# /dev/knox_kap
+allow rild knox_kap_device:chr_file rw_file_perms;
+
+# /dev/block/sda8
+allow rild radio_block_device:blk_file r_file_perms;
+
+# /dev
+allow rild audioserver:dir r_dir_perms;
+
+# /proc/<pid>/cmdline
+allow rild audioserver:file r_file_perms;
+
 # /dev/mbin0
 allow rild block_device:dir r_dir_perms;
 allow rild emmcblk_device:blk_file r_file_perms;
@@ -29,7 +43,6 @@ allow rild mediaserver:file { open read getattr };
 # /data/misc/radio/*
 allow rild radio_data_file:dir rw_dir_perms;
 allow rild radio_data_file:file create_file_perms;
-# /data/data/com.android.providers.telephony/databases/telephony.db
 allow rild radio_data_file:lnk_file r_file_perms;
 
 # sdcard/SDET_PLMN/input/MNCMCC.txt
@@ -37,3 +50,10 @@ allow rild storage_file:dir { r_dir_perms };
 allow rild storage_file:lnk_file { r_file_perms };
 allow rild mnt_user_file:dir { r_dir_perms };
 allow rild mnt_user_file:lnk_file { r_file_perms };
+
+allow rild radio_block_device:blk_file { read open };
+allow rild ctl_rildaemon_prop:property_service set;
+allow rild self:capability chown;
+
+allow rild audioserver:dir search;
+allow rild audioserver:file { read open getattr };
diff --git a/sepolicy/system_server.te b/sepolicy/system_server.te
index 8432fa2..b13cf70 100644
--- a/sepolicy/system_server.te
+++ b/sepolicy/system_server.te
@@ -30,5 +30,23 @@ allow system_server sysfs_mdnie_writable:dir rw_dir_perms;
 allow system_server sysfs_mdnie_writable:file rw_file_perms;
 
 # app efs
-allow system_server app_efs_file:file read;
+allow system_server app_efs_file:file { read open };
 allow system_server batch_io_device:chr_file { open read write ioctl };
+allow system_server app_efs_file:dir search;
+
+allow system_server debugfs:dir { read open };
+
+# debugging
+allow system_server sysfs_debug:file rw_file_perms;
+
+####################################
+# Nexus7420 Power HAL
+#
+# directory
+allow system_server power_hal_sysfs:dir       rw_dir_perms;
+allow system_server power_hal_sysfs:dir       rw_dir_perms;
+allow system_server power_hal_data_files:dir  rw_dir_perms;
+# files
+allow system_server power_hal_devfs:file      rw_file_perms;
+allow system_server power_hal_sysfs:file      rw_file_perms;
+allow system_server power_hal_data_files:file rw_file_perms;
diff --git a/sepolicy/tee.te b/sepolicy/tee.te
index 833b9c3..cf24c53 100644
--- a/sepolicy/tee.te
+++ b/sepolicy/tee.te
@@ -5,3 +5,14 @@ file_type_auto_trans(tee, apk_data_file, tee_data_file);
 
 allow tee property_socket:sock_file write;
 allow tee init:unix_stream_socket connectto;
+
+allow tee efs_file:dir { getattr };
+allow tee efs_file:file { getattr open read };
+
+allow tee efs_file:dir search;
+allow tee system_prop:property_service set;
+
+allow tee prov_efs_file:dir search;
+
+allow tee mobicore_data_file:file { create write open };
+allow tee mobicore_data_file:dir { write search add_name create };
diff --git a/sepolicy/ueventd.te b/sepolicy/ueventd.te
index 59e0ace..0f56626 100644
--- a/sepolicy/ueventd.te
+++ b/sepolicy/ueventd.te
@@ -4,4 +4,4 @@ allow ueventd emmcblk_device:blk_file create_file_perms;
 # /sys/devices/virtual/misc/multipdp/uevent
 allow ueventd sysfs_multipdp_writable:file rw_file_perms;
 
-allow ueventd emmcblk_device:blk_file { relabelfrom relabelto create setattr unlink };
+allow ueventd camera_device:file { relabelto getattr write open };
diff --git a/sepolicy/untrusted_app.te b/sepolicy/untrusted_app.te
index 18d3966..28d9ce9 100644
--- a/sepolicy/untrusted_app.te
+++ b/sepolicy/untrusted_app.te
@@ -1,3 +1,11 @@
 allow untrusted_app battery_service:service_manager find;
 allow untrusted_app device:dir read;
 allow untrusted_app untrusted_app:udp_socket ioctl;
+allow untrusted_app power_hal_data_files:file rw_file_perms;
+
+# allow access to some minor system-files
+allow untrusted_app sysfs_debug_untrusted:file r_file_perms;
+
+# su-daemon
+allow untrusted_app superuser_device:sock_file write;
+allow untrusted_app sudaemon:unix_stream_socket connectto;
diff --git a/sepolicy/zygote.te b/sepolicy/zygote.te
new file mode 100644
index 0000000..e9da348
--- /dev/null
+++ b/sepolicy/zygote.te
@@ -0,0 +1,4 @@
+allow zygote self:capability sys_nice;
+allow zygote debugfs_trace_marker:file r_file_perms;
+allow zygote sysfs_debug:file r_file_perms;
+allow zygote sysfs_debug_untrusted:file r_file_perms;
